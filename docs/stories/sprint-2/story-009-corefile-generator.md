# Story-009: Corefile 生成服务

## 基本信息
- **故事ID**: Story-009
- **所属Sprint**: Sprint 2
- **优先级**: High
- **预估工作量**: 3 Story Points (1.5 天)
- **状态**: Todo

## 用户故事
**As a** 系统管理员
**I want** 系统自动根据数据库中的 DNS 记录生成 Corefile
**So that** 我不需要手动编辑配置文件，减少出错风险

## 背景描述
Corefile 是 CoreDNS 的核心配置文件，定义了 DNS 解析规则。本功能需要根据数据库中的 DNS 记录自动生成符合 CoreDNS 格式的 Corefile，并支持模板化配置。

## 验收标准

- [x] AC1: Corefile 生成服务已实现
  - 从数据库读取所有 active 状态的 DNS 记录
  - 按 Zone 分组生成配置
  - 生成符合 CoreDNS 语法的 Corefile

- [x] AC2: POST `/api/corefile/generate` 端点已实现
  - 触发 Corefile 生成
  - 返回生成的 Corefile 内容
  - 返回生成统计信息（记录数、Zone 数等）

- [x] AC3: Corefile 模板支持
  - 使用 Jinja2 模板引擎
  - 支持自定义模板配置
  - 包含 Zone 配置、记录配置、插件配置

- [x] AC4: 生成的 Corefile 格式正确
  ```
  seadee.com.cn {
      hosts {
          172.27.0.3 app.seadee.com.cn
          172.27.0.4 web.seadee.com.cn
          fallthrough
      }
      log
      errors
  }

  example.com {
      hosts {
          192.168.1.10 www.example.com
          fallthrough
      }
      log
      errors
  }

  . {
      forward . 8.8.8.8 8.8.4.4
      log
      errors
      cache 30
  }
  ```

- [x] AC5: 文件写入功能
  - 生成的 Corefile 写入指定路径
  - 写入前创建备份
  - 验证文件写入权限

- [x] AC6: 响应格式符合规范
  ```json
  {
    "success": true,
    "data": {
      "corefile_path": "/data/Corefile",
      "content": "seadee.com.cn {\n  hosts {\n...",
      "stats": {
        "total_zones": 2,
        "total_records": 5,
        "active_records": 5
      },
      "generated_at": "2025-11-26T10:00:00Z"
    },
    "message": "Corefile generated successfully"
  }
  ```

- [x] AC7: 单元测试覆盖率 ≥ 80%
  - 测试模板渲染
  - 测试 Zone 分组
  - 测试文件写入
  - 测试错误处理

## 技术实现要点

### 1. Corefile 模板（app/templates/Corefile.j2）
```jinja2
{# CoreDNS Configuration File #}
{# Generated by CoreDNS Manager #}
{# Generated at: {{ generated_at }} #}

{% for zone in zones %}
{{ zone.name }} {
    hosts {
        {% for record in zone.records %}
        {{ record.ip_address }} {{ record.hostname }}.{{ zone.name }}
        {% endfor %}
        fallthrough
    }
    log
    errors
}

{% endfor %}
. {
    forward . 8.8.8.8 8.8.4.4
    log
    errors
    cache 30
}
```

### 2. Corefile 生成服务（app/services/corefile_service.py）
```python
from sqlmodel import Session, select
from app.models.dns_record import DNSRecord
from jinja2 import Environment, FileSystemLoader
from datetime import datetime
from pathlib import Path
from typing import Dict, List
import logging

logger = logging.getLogger(__name__)

class CorefileService:
    def __init__(self, template_dir: str = "app/templates"):
        """
        初始化 Corefile 服务

        Args:
            template_dir: 模板文件目录
        """
        self.env = Environment(loader=FileSystemLoader(template_dir))
        self.template = self.env.get_template("Corefile.j2")

    def generate_corefile(
        self,
        session: Session,
        output_path: str = None
    ) -> Dict:
        """
        生成 Corefile

        Args:
            session: 数据库会话
            output_path: 输出文件路径（可选）

        Returns:
            Dict: 生成结果
        """
        # 获取所有 active 记录
        records = session.exec(
            select(DNSRecord).where(DNSRecord.status == "active")
        ).all()

        # 按 Zone 分组
        zones_dict = {}
        for record in records:
            if record.zone not in zones_dict:
                zones_dict[record.zone] = {
                    "name": record.zone,
                    "records": []
                }
            zones_dict[record.zone]["records"].append(record)

        zones = list(zones_dict.values())

        # 渲染模板
        generated_at = datetime.utcnow().isoformat()
        content = self.template.render(
            zones=zones,
            generated_at=generated_at
        )

        # 统计信息
        stats = {
            "total_zones": len(zones),
            "total_records": len(records),
            "active_records": len(records)
        }

        result = {
            "content": content,
            "stats": stats,
            "generated_at": generated_at
        }

        # 如果指定了输出路径，写入文件
        if output_path:
            self._write_corefile(output_path, content)
            result["corefile_path"] = output_path

        return result

    def _write_corefile(self, path: str, content: str):
        """
        写入 Corefile

        Args:
            path: 文件路径
            content: 文件内容
        """
        try:
            file_path = Path(path)
            # 确保目录存在
            file_path.parent.mkdir(parents=True, exist_ok=True)

            # 写入文件
            with open(file_path, "w", encoding="utf-8") as f:
                f.write(content)

            logger.info(f"Corefile written to {path}")

        except Exception as e:
            logger.error(f"Failed to write Corefile: {str(e)}")
            raise

    def validate_corefile(self, content: str) -> bool:
        """
        验证 Corefile 格式（基本验证）

        Args:
            content: Corefile 内容

        Returns:
            bool: 是否有效
        """
        # 基本验证：检查是否包含必要的块
        required_blocks = ["{", "}", "hosts"]
        return all(block in content for block in required_blocks)
```

### 3. Pydantic 模型（app/schemas/corefile.py）
```python
from pydantic import BaseModel
from datetime import datetime

class CorefileStats(BaseModel):
    total_zones: int
    total_records: int
    active_records: int

class CorefileGenerateResponse(BaseModel):
    success: bool = True
    data: dict
    message: str

class CorefileData(BaseModel):
    corefile_path: str
    content: str
    stats: CorefileStats
    generated_at: str
```

### 4. API 路由（app/api/corefile.py）
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlmodel import Session
from app.database import get_session
from app.services.corefile_service import CorefileService
from app.schemas.corefile import CorefileGenerateResponse
from app.config import settings

router = APIRouter(prefix="/api/corefile", tags=["Corefile"])

@router.post("/generate", response_model=CorefileGenerateResponse)
async def generate_corefile(
    session: Session = Depends(get_session)
):
    """
    生成 Corefile

    根据数据库中的 DNS 记录生成 CoreDNS 配置文件
    """
    try:
        service = CorefileService()
        result = service.generate_corefile(
            session=session,
            output_path=settings.corefile_path
        )

        return {
            "success": True,
            "data": result,
            "message": "Corefile generated successfully"
        }

    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to generate Corefile: {str(e)}"
        )

@router.get("/preview")
async def preview_corefile(
    session: Session = Depends(get_session)
):
    """
    预览 Corefile

    生成但不写入文件，用于预览
    """
    service = CorefileService()
    result = service.generate_corefile(session=session)

    return {
        "success": True,
        "data": result
    }
```

### 5. 注册路由（app/main.py）
```python
from app.api import corefile

app.include_router(corefile.router)
```

## 依赖关系
- **前置依赖**:
  - Story-002 (需要 DNSRecord 模型)
- **后置依赖**:
  - Story-010 (备份功能依赖 Corefile 生成)
  - Story-011 (重载功能需要在生成后触发)

## 测试用例

### 测试场景 1: 成功生成 Corefile
```python
def test_generate_corefile_success():
    # 创建测试记录
    records = [
        {"zone": "seadee.com.cn", "hostname": "app", "ip_address": "172.27.0.3"},
        {"zone": "seadee.com.cn", "hostname": "web", "ip_address": "172.27.0.4"}
    ]
    for record in records:
        client.post("/api/records", json=record)

    # 生成 Corefile
    response = client.post("/api/corefile/generate")
    assert response.status_code == 200
    data = response.json()
    assert data["success"] is True
    assert "content" in data["data"]
    assert data["data"]["stats"]["total_zones"] == 1
    assert data["data"]["stats"]["total_records"] == 2
```

### 测试场景 2: 预览 Corefile
```python
def test_preview_corefile():
    response = client.get("/api/corefile/preview")
    assert response.status_code == 200
    data = response.json()
    assert "content" in data["data"]
```

### 测试场景 3: Zone 分组正确
```python
def test_zone_grouping():
    # 创建多个 Zone 的记录
    records = [
        {"zone": "zone1.com", "hostname": "app", "ip_address": "172.27.0.3"},
        {"zone": "zone2.com", "hostname": "web", "ip_address": "172.27.0.4"}
    ]
    for record in records:
        client.post("/api/records", json=record)

    response = client.post("/api/corefile/generate")
    data = response.json()
    content = data["data"]["content"]

    assert "zone1.com" in content
    assert "zone2.com" in content
```

### 测试场景 4: 只包含 active 记录
```python
def test_only_active_records():
    # 创建 active 和 inactive 记录
    client.post("/api/records", json={
        "zone": "test.com", "hostname": "active", "ip_address": "172.27.0.3"
    })
    inactive = client.post("/api/records", json={
        "zone": "test.com", "hostname": "inactive", "ip_address": "172.27.0.4"
    })
    inactive_id = inactive.json()["data"]["id"]

    # 标记为 inactive
    client.patch(f"/api/records/{inactive_id}", json={"status": "inactive"})

    # 生成 Corefile
    response = client.post("/api/corefile/generate")
    content = response.json()["data"]["content"]

    assert "active.test.com" in content
    assert "inactive.test.com" not in content
```

### 测试场景 5: Corefile 格式验证
```python
def test_corefile_format():
    client.post("/api/records", json={
        "zone": "test.com", "hostname": "app", "ip_address": "172.27.0.3"
    })

    response = client.post("/api/corefile/generate")
    content = response.json()["data"]["content"]

    # 验证基本格式
    assert "test.com {" in content
    assert "hosts {" in content
    assert "172.27.0.3 app.test.com" in content
    assert "fallthrough" in content
    assert "}" in content
```

## 完成定义 (Definition of Done)
- [x] Corefile 生成服务已实现
- [x] 所有验收标准已满足
- [x] Jinja2 模板已创建
- [x] API 端点已实现
- [x] Zone 分组逻辑已实现
- [x] 文件写入功能已实现
- [x] 单元测试通过（覆盖率 ≥ 80%）
- [x] API 文档已生成
- [x] 代码已合并到 `develop` 分支

## 参考资料
- [CoreDNS Configuration](https://coredns.io/manual/toc/)
- [Jinja2 Documentation](https://jinja.palletsprojects.com/)
- [CoreDNS Hosts Plugin](https://coredns.io/plugins/hosts/)

## 备注
- Corefile 模板可以通过配置文件自定义
- 考虑添加 Corefile 语法验证功能
- 可以支持更多 CoreDNS 插件配置
- 生成前应该验证 DNS 记录的一致性

---

**创建日期**: 2025-11-26
**最后更新**: 2025-11-26
**创建者**: 开发团队
