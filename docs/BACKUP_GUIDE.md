# Corefile 备份功能说明

## 功能概述

CoreDNS Manager 提供了完整的 Corefile 备份管理功能,包括:

- ✅ 自动备份:生成 Corefile 时自动创建备份
- ✅ 手动备份:随时创建 Corefile 的快照
- ✅ 备份列表:查看所有历史备份
- ✅ 备份恢复:回滚到任意历史版本
- ✅ 备份删除:清理不需要的备份(最新备份受保护)

## 使用方法

### 1. 访问备份管理页面

访问 `/corefile` 页面,在页面底部可以看到 "Corefile 备份" 部分。

### 2. 创建手动备份

点击 "创建备份" 按钮即可立即创建当前 Corefile 的备份。

### 3. 查看备份列表

备份列表显示所有历史备份,包括:
- **ID**: 备份的唯一标识符(时间戳格式)
- **文件名**: 备份文件的完整名称
- **大小**: 备份文件大小
- **创建时间**: 备份创建的时间
- **标记**: 最新备份会有 "最新" 标记

### 4. 恢复备份

在备份列表中点击 "恢复" 按钮:
1. 系统会先自动备份当前 Corefile
2. 然后用选中的备份替换当前 Corefile
3. 完成后显示恢复成功消息

### 5. 删除备份

在备份列表中点击 "删除" 按钮可删除不需要的备份。

**注意**: 最新的备份不能被删除,以确保始终有至少一个可用备份。

## 自动备份机制

在以下情况下,系统会自动创建备份:

1. **生成 Corefile**: 点击 "生成并写入" 按钮时
2. **恢复备份**: 在恢复旧备份之前,会先备份当前版本

## 配置说明

备份功能的配置在 `.env` 文件中:

```env
# Corefile 备份目录
COREFILE_BACKUP_DIR=./data/backups

# 最大备份数量(超过后自动删除最旧的备份)
MAX_COREFILE_BACKUPS=30

# 单个备份文件最大大小(字节)
MAX_BACKUP_SIZE_BYTES=5242880  # 5MB
```

### 配置项说明

- `COREFILE_BACKUP_DIR`: 备份文件存储目录
- `MAX_COREFILE_BACKUPS`: 保留的最大备份数量,默认 30 个
- `MAX_BACKUP_SIZE_BYTES`: 单个备份文件的最大大小限制,默认 5MB

## API 接口

### 创建备份
```http
POST /api/corefile/backups
```

### 列出备份
```http
GET /api/corefile/backups?page=1&page_size=20
```

### 获取备份详情
```http
GET /api/corefile/backups/{backup_id}
```

### 恢复备份
```http
POST /api/corefile/restore/{backup_id}
```

### 删除备份
```http
DELETE /api/corefile/backups/{backup_id}
```

## 备份文件命名规则

备份文件采用以下命名格式:
```
Corefile.backup.{YYYYMMDD}_{HHMMSS}_{microseconds}
```

示例:
```
Corefile.backup.20251209_025946_338184
```

这种命名方式确保:
- 备份按时间顺序排列
- 每个备份都有唯一的标识符
- 易于人工识别和查找

## 磁盘空间管理

系统会自动管理备份磁盘空间:

1. **创建前检查**: 创建备份前检查可用磁盘空间
2. **自动清理**: 超过最大备份数量时,自动删除最旧的备份
3. **大小限制**: 超过大小限制的 Corefile 无法备份

## 故障排除

### 备份创建失败

**问题**: 点击"创建备份"按钮后显示错误

**可能原因**:
1. Corefile 文件不存在
2. 磁盘空间不足
3. 备份目录权限问题
4. Corefile 超过最大大小限制

**解决方法**:
1. 检查 Corefile 是否存在: `ls -l ./data/Corefile`
2. 检查磁盘空间: `df -h`
3. 检查目录权限: `ls -ld ./data/backups`
4. 调整配置项 `MAX_BACKUP_SIZE_BYTES`

### 备份列表为空

**问题**: 备份页面显示"暂无备份"

**可能原因**:
1. 尚未创建任何备份
2. 备份目录路径配置错误
3. 备份文件被手动删除

**解决方法**:
1. 点击"创建备份"按钮创建第一个备份
2. 检查配置: `COREFILE_BACKUP_DIR`
3. 检查备份目录: `ls ./data/backups`

### 无法恢复备份

**问题**: 点击"恢复"按钮后操作失败

**可能原因**:
1. 备份文件已被删除
2. 文件权限问题

**解决方法**:
1. 刷新备份列表
2. 检查备份文件是否存在
3. 检查文件权限

## 最佳实践

1. **定期备份**: 在进行重大更改前手动创建备份
2. **保留历史**: 建议保留至少 10-30 个备份
3. **磁盘监控**: 定期检查备份目录的磁盘使用情况
4. **测试恢复**: 定期测试备份恢复功能
5. **外部备份**: 重要的配置建议同时进行外部备份

## 安全说明

- 备份文件包含完整的 DNS 配置信息
- 确保备份目录的访问权限正确设置
- 建议定期导出重要备份到外部存储
- 不要将备份文件提交到公开的版本控制系统

## 技术实现

备份功能基于文件系统实现,具有以下特点:

- **高性能**: 使用文件复制,速度快
- **可靠性**: 保留文件元数据(时间戳等)
- **简单性**: 无需额外数据库或服务
- **可维护**: 备份文件可直接查看和编辑

## 版本历史

- v1.0.0 (2025-12-09): 初始版本,实现基础备份功能
  - 手动创建备份
  - 自动备份(生成时)
  - 备份列表、恢复、删除
  - 磁盘空间管理
  - 备份数量限制
